quest energy_system begin
	state start begin
		when 20001.chat.locale_quest(963) begin
			say_title(mob_name(20001))
			say(locale_quest(964))
			wait()
			say_title(mob_name(20001))
			say(locale_quest(965))
			wait()
			say_title(mob_name(20001))
			say(locale_quest(966))
			setstate(can_make)
		end
	end

	state can_make begin
		function setting()
			return
			{
				["prob_acc_table"] = {
					["35to50"] = {30, 55, 70, 80, 90, 95, 97, 98, 99, 100},
					["51to70"] = {20, 40, 60, 75, 85, 91, 96, 98, 99, 100},
					["upto70"] = {10, 25, 45, 65, 80, 88, 94, 97, 99, 100}
				},
				["item_num_table"] = {0, 1, 2, 3, 4, 6, 8, 10, 12, 15},
				["energy_stone"] = 51001,
				["charging_stone"] = 51002
			}
		end

		function getItemNum(str, r)
			local setting = energy_system.setting()
			for i = 1, 10 do
				if r < setting.prob_acc_table[str][i] then
					return setting.item_num_table[i]
				end
			end

			return 0
		end

		when 20001.chat.locale_quest(967) begin
			say_title(mob_name(20001))
			say(locale_quest(968))
			wait()
			say_title(mob_name(20001))
			say(locale_quest(969))
			wait()
			if pc.get_level() < 35 then
				say_title(mob_name(20001))
				say(locale_quest(970))
			else
				say_title(mob_name(20001))
				say(locale_quest(971))
			end
		end

		when 20001.take begin
			if pc.get_level() < 35 then
				say_title(mob_name(20001))
				say(locale_quest(972))
				return
			end

			local item_vnum = item.vnum
			local levelLimit = item.get_level_limit(item_vnum)
			local setting = energy_system.setting()

			if levelLimit == nil then
				say_title(mob_name(20001))
				say(locale_quest(973))
				wait()
			elseif item.get_type() == ITEM_WEAPON and item.get_sub_type() == WEAPON_ARROW then
				say_title(mob_name(20001))
				say(locale_quest(973))
				wait()
			elseif levelLimit < 35 then
				say_title(mob_name(20001))
				say(locale_quest(974))
			else
				say_title(mob_name(20001))
				say(item_name(item_vnum))
				if item.get_attribute_count() > 0 then
					say(string.format(locale_quest(10822), item.get_attribute_count()))
				end
				say(locale_quest(975))
				local s = select(locale_quest(976),locale_quest(977))
				if s == 1 then
					if not item.is_available() then return end
					item.remove()
					local r = number(1, 100)
					local n

					if levelLimit >= 35 and levelLimit <= 50 then
						n = energy_system.getItemNum("35to50", r)
					elseif levelLimit > 50 and levelLimit <= 70 then
						n = energy_system.getItemNum("51to70", r)
					else
						n = energy_system.getItemNum("upto70", r)
					end

					if (n == 0) then
						say_title(mob_name(20001))
						say(locale_quest(978))
					else
						pc.give_item2(setting.energy_stone, n)
						say_title(mob_name(20001))
						say(string.format(locale_quest(979),n))
					end
				end
			end
		end

		when 20001.chat.locale_quest(980) begin
			local setting = energy_system.setting()
			local need = 30

			say_title(mob_name(20001))
			say(string.format(locale_quest(981),need))
			wait()

			if pc.get_level() < 35 then
				say_title(mob_name(20001))
				say(locale_quest(970))
				return
			end

			if pc.count_item(setting.energy_stone) < need then
				say_title(mob_name(20001))
				say(string.format(locale_quest(982), need))
				return
			else
				say_title(mob_name(20001))
				say(string.format(locale_quest(983), need))
				wait()
			end

			local charge = 1000
			say_title(mob_name(20001))
			say(string.format(locale_quest(984), charge))

			local s = select(locale_quest(985),locale_quest(986))
			if s == 2 then
				say_title(mob_name(20001))
				say(locale_quest(987))
				return
			end

			if pc.get_gold() < charge then
				say_title(mob_name(20001))
				say(locale_quest(988))
				return
			end

			if pc.count_item(setting.energy_stone) < need then
				return
			end

			pc.change_gold(-charge)
			pc.remove_item(setting.energy_stone, need)

			if pc.getqf("hasExperience") == 0 then
				say_title(mob_name(20001))
				say(locale_quest(989))
				pc.give_item2(setting.charging_stone, 1)
				pc.setqf("hasExperience", 1)
				return
			end

			local r = number(1, 100)
			if r > 30 then
				say_title(mob_name(20001))
				say(locale_quest(990))
				return
			end

			say_title(mob_name(20001))
			say(locale_quest(991))
			pc.give_item2(setting.charging_stone, 1)
		end
	end
end
