define COLONY_GUARD_VNUM 20401 -- Colony Guard (Lycan NPC) VNUM
define UNKNOWN_STONE_COUNT_FLAG "unknown_stone_count" -- Quest flag name for the unknown stone count
define UNKNOWN_STONE_VNUM 31093 -- Unknown Stone (Droppable on Monsters) VNUM
define EXP_AMOUNT_REWARD 300 -- Amount of received exp upon quest completion
define ITEM_ONE_REWARD 27001 -- ITEM_ONE (Red Potions (s)) received upon quest completion
define ITEM_ONE_REWARD_AMOUNT 10 -- Amount (x10) of received ITEM_ONE upon quest completion
define MYONGHORANG_VNUM 20400 -- Myonghorang (Lycan NPC) VNUM
define ITEM_TWO_REWARD 27001 -- ITEM_TWO (Red Potions (s)) received upon quest completion
define ITEM_TWO_AMOUNT_REWARD 10 -- Amount (x10) of received ITEM_TWO upon quest completion

quest unknown_stone begin
	state start begin end
	state trigger begin
		when enter begin
			pc.setqf(UNKNOWN_STONE_COUNT_FLAG, 0)
		end

		when letter begin
			send_letter(locale_quest(6363))
			q.set_counter_name(locale_quest(6363))
			unknown_stone.unknown_stone_counter()
		end

		when button or info begin
			say_title(locale_quest(6363))
			say(string.format(locale_quest(6367), pc.getqf(UNKNOWN_STONE_COUNT_FLAG)))
		end

		when kill with npc.is_pc() == false begin
			local unknown_stone_count = pc.getqf(UNKNOWN_STONE_COUNT_FLAG)
			-- 25% this time
			if number(1, 4) == 1 then
				pc.setqf(UNKNOWN_STONE_COUNT_FLAG, unknown_stone_count + 1)
				pc.give_item2(UNKNOWN_STONE_VNUM)
				unknown_stone.unknown_stone_counter()
			end
		end

		function unknown_stone_counter()
			local unknown_stone_total = 0
			local unknown_stone_remaining_count = 3 - pc.getqf(UNKNOWN_STONE_COUNT_FLAG)

			if unknown_stone_remaining_count < 0 then
				unknown_stone_remaining_count = 0
			end

			unknown_stone_total = unknown_stone_total + unknown_stone_remaining_count
			q.set_counter_value(unknown_stone_total)
			if unknown_stone_total == 0 then
				say_title(locale_quest(6409))
				say(locale_quest(6407))
				set_state("back_to_the_guard")
			end
		end

		when COLONY_GUARD_VNUM.chat.locale_quest(6363) begin
			say_title(mob_name(COLONY_GUARD_VNUM))
			say(locale_quest(6365))
		end

		when leave begin
			pc.setqf(UNKNOWN_STONE_COUNT_FLAG, 0)
			q.done()
		end
	end

	state back_to_the_guard begin
		when letter begin
			send_letter(locale_quest(6409))
			local v = find_npc_by_vnum(COLONY_GUARD_VNUM)
			if 0 ~= v then
				target.vid("__TARGET__", v, locale_quest(6409))
			end
		end

		when button or info begin
			say_title(locale_quest(6409))
			say(locale_quest(6407))
		end

		when __TARGET__.target.click or COLONY_GUARD_VNUM.chat.locale_quest(6363) begin
			target.delete("__TARGET__")
			clear_letter()

			say_title(mob_name(COLONY_GUARD_VNUM))
			say()
			say(locale_quest(6366))
			say_reward(string.format(locale_quest(5043), item_name(ITEM_ONE_REWARD),ITEM_ONE_REWARD_AMOUNT))
			say_reward(string.format(locale_quest(6882), EXP_AMOUNT_REWARD))
			say()
			pc.give_exp2(EXP_AMOUNT_REWARD)
			pc.give_item2(ITEM_ONE_REWARD, ITEM_ONE_REWARD_AMOUNT)
			pc.remove_item(UNKNOWN_STONE_VNUM, pc.count_item(UNKNOWN_STONE_VNUM))
			wait()
			set_state(__COMPLETE__)
			set_quest_state("source_of_the_devil", "trigger")
		end
	end

	state __COMPLETE__ begin
	end
end
